import{a8 as W,a9 as H,y as I,o as c,c as m,F as L,k as j,a as o,t as z,d as S,T as Y,b as x,w as U,u as l,I as _,e as O,j as G,g as D,a1 as q,r as p,q as J,ay as K,v as X,s as N,W as Z,aQ as ee,aF as te,$ as se,a0 as re,n as ie}from"./Brb_7992.js";import{S as A}from"./BQxta0Da.js";import{u as ne}from"./ddpOXc7a.js";import{C as oe}from"./DGSq2Y25.js";const ae=W("questionAnswers",{state:()=>({answeredQuestions:{},submittingQuestions:{},temporaryAnswers:{},questionErrors:{}}),actions:{isQuestionAnswered(e,t){return this.answeredQuestions[e]?.hasOwnProperty(t)||!1},setAnsweredQuestion(e,t,u){this.answeredQuestions[e]||(this.answeredQuestions[e]={}),this.answeredQuestions[e][t]=u,this.temporaryAnswers[e]&&delete this.temporaryAnswers[e][t],this.questionErrors[e]&&delete this.questionErrors[e][t]},isQuestionSubmitting(e,t){return this.submittingQuestions[e]?.hasOwnProperty(t)||!1},setQuestionSubmitting(e,t,u){this.submittingQuestions[e]||(this.submittingQuestions[e]={}),u?this.submittingQuestions[e][t]=!0:delete this.submittingQuestions[e][t]},setTemporaryAnswer(e,t,u){this.temporaryAnswers[e]||(this.temporaryAnswers[e]={}),this.temporaryAnswers[e][t]=u},getTemporaryAnswer(e,t){return this.temporaryAnswers[e]?.[t]||null},setQuestionError(e,t,u){this.questionErrors[e]||(this.questionErrors[e]={}),this.questionErrors[e][t]=u},clearQuestionError(e,t){this.questionErrors[e]&&delete this.questionErrors[e][t]},getQuestionError(e,t){return this.questionErrors[e]?.[t]||null},clearAnsweredQuestion(e,t){this.answeredQuestions[e]&&delete this.answeredQuestions[e][t],this.submittingQuestions[e]&&delete this.submittingQuestions[e][t],this.temporaryAnswers[e]&&delete this.temporaryAnswers[e][t],this.questionErrors[e]&&delete this.questionErrors[e][t]},clearQuizAnswers(e){delete this.answeredQuestions[e],delete this.submittingQuestions[e],delete this.temporaryAnswers[e],delete this.questionErrors[e]},clearAllAnswers(){this.answeredQuestions={},this.submittingQuestions={},this.temporaryAnswers={},this.questionErrors={}},updateAnsweredQuestion(e,t,u){this.answeredQuestions[e]?.hasOwnProperty(t)&&(this.answeredQuestions[e][t]=u)}},getters:{getAnswerForQuestion:e=>(t,u)=>e.answeredQuestions[t]?.[u]||null,answeredQuestionsCount:e=>t=>{const u=e.answeredQuestions[t]?Object.keys(e.answeredQuestions[t]).length:0,h=e.temporaryAnswers[t]?Object.keys(e.temporaryAnswers[t]).filter(d=>!e.answeredQuestions[t]?.hasOwnProperty(d)).length:0;return u+h},submittingQuestionsCount:e=>t=>e.submittingQuestions[t]?Object.keys(e.submittingQuestions[t]).length:0}}),le={class:"space-y-6"},ue={class:"flex gap-4"},de={class:"font-bold text-lg text-blue-600 dark:text-blue-400 min-w-[24px]"},ce={class:"flex-grow"},ge={class:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4 mb-4"},me=["innerHTML"],fe={class:"flex items-center gap-2 flex-shrink-0"},we={class:"text-xs font-medium bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 px-2 py-1 rounded-md border border-blue-100 dark:border-blue-800"},pe={class:"text-xs font-medium bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 px-2 py-1 rounded-md border border-orange-100 dark:border-orange-800 flex items-center gap-1"},he={key:0,class:"mb-4 grid grid-cols-1 sm:grid-cols-2 gap-4"},be=["src"],ye={class:"space-y-3"},ve=["onClick"],xe={class:"flex items-center h-5 mt-1"},_e=["name","checked","disabled"],ke={class:"ml-3 text-sm flex-grow"},Qe=["innerHTML"],Ae={key:0,class:"mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2"},$e=["src"],Ee={class:"mt-4 flex justify-end gap-2"},ze=["onClick"],Ce=["onClick","disabled"],Te=["onClick"],Se={__name:"QuestionsListViewer",props:{courseId:{type:[Number,String],required:!1},questions:{type:Array,required:!0},quizId:{type:Number,required:!0},quiz:{type:Object,required:!0},quizResult:{type:Object,required:!1}},setup(e){const t=e,u=H(),{user:h}=ne(),d=ae(),$=p({}),w=s=>d.isQuestionAnswered(t.quizId,s),g=s=>!!$.value[s],k=s=>w(s)&&!g(s),b=p({}),R=p({});I(()=>{t.questions&&t.questions.forEach(s=>{const a=s.user_answer?.answer_id||s.isAnsweredByAuth,i=s.user_answer?.id;a&&(d.setAnsweredQuestion(t.quizId,s.id,a),d.setTemporaryAnswer(t.quizId,s.id,a),i&&(b.value[s.id]=i))})});const y=(s,a)=>d.getTemporaryAnswer(t.quizId,s)===a,Q=(s,a)=>y(s,a)?"border-blue-500 bg-blue-50 dark:bg-blue-900/10 ring-1 ring-blue-500":"border-gray-200 dark:border-gray-700",C=(s,a)=>{k(s.id)||d.setTemporaryAnswer(t.quizId,s.id,a.id)},F=s=>{const a=d.getTemporaryAnswer(t.quizId,s),i=d.getAnswerForQuestion(t.quizId,s);return d.isQuestionAnswered(t.quizId,s)?a&&a!==i:!!a},V=s=>{$.value[s]=!0},M=s=>{const a=d.getAnswerForQuestion(t.quizId,s);a&&d.setTemporaryAnswer(t.quizId,s,a),$.value[s]=!1},B=async s=>{const a=d.getTemporaryAnswer(t.quizId,s.id);if(!a)return;const i=h.value?.points||0,v=s.points||0;if(i<v){await A.fire({icon:"error",title:"แต้มไม่เพียงพอ!",text:`คุณมี ${i} แต้ม แต่ข้อนี้ต้องใช้ ${v} แต้มในการตอบ`,confirmButtonText:"ตกลง"});return}d.setQuestionSubmitting(t.quizId,s.id,!0);const n={answer_id:a,course_id:t.courseId||t.quiz.course_id};console.log("Sending answer payload:",n);try{let r,f=s.user_answer?.id;!f&&b.value[s.id]&&(f=b.value[s.id]),f||d.isQuestionAnswered(t.quizId,s.id)?f?r=await u.put(`/api/quizs/${t.quizId}/questions/${s.id}/answers/${f}`,n):r=await u.post(`/api/quizs/${t.quizId}/questions/${s.id}/answers`,n):r=await u.post(`/api/quizs/${t.quizId}/questions/${s.id}/answers`,n),r&&r.authAnswerQuestion&&T(s.id,a,r.authAnswerQuestion,r.points)}catch(r){const f=r.statusCode||r.status||r.response?.status;if(console.log("Error caught in confirmAnswer:",{status:f,data:r.data,error:r}),f===422&&r.data&&r.data.existing_answer_id){console.log("Answer already exists, switching to update...",r.data.existing_answer_id);const P=r.data.existing_answer_id;try{const E=await u.put(`/api/quizs/${t.quizId}/questions/${s.id}/answers/${P}`,n);if(E&&E.authAnswerQuestion){T(s.id,a,E.authAnswerQuestion,E.points);return}}catch(E){console.error("Failed to update existing answer",E)}}console.error("Failed to save answer",r),A.fire({icon:"error",title:"เกิดข้อผิดพลาด",text:r.data?.message||"ไม่สามารถบันทึกคำตอบได้ กรุณาลองใหม่"})}finally{d.setQuestionSubmitting(t.quizId,s.id,!1)}},T=async(s,a,i,v)=>{d.setAnsweredQuestion(t.quizId,s,a),b.value[s]=i,v!==void 0&&(R.value[s]=v),$.value[s]=!1,await A.fire({icon:"success",title:"บันทึกคำตอบสำเร็จ",toast:!0,position:"top-end",showConfirmButton:!1,timer:1500})};return(s,a)=>(c(),m("div",le,[(c(!0),m(L,null,j(e.questions,(i,v)=>(c(),m("div",{key:i.id,class:"p-6 bg-white dark:bg-gray-800 shadow-sm border border-gray-100 dark:border-gray-700 rounded-xl"},[o("div",ue,[o("span",de,z(v+1)+".",1),o("div",ce,[o("div",ge,[o("div",{class:"prose dark:prose-invert max-w-none text-gray-800 dark:text-gray-100 flex-grow",innerHTML:i.text},null,8,me),o("div",fe,[o("div",we,z(i.points)+" คะแนน ",1),o("div",pe,[o("span",null,z(i.pp_fine||0)+" แต้ม",1)])])]),i.images&&i.images.length>0?(c(),m("div",he,[(c(!0),m(L,null,j(i.images,n=>(c(),m("div",{key:n.id,class:"rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700"},[o("img",{src:n.full_url,class:"w-full h-auto object-cover",loading:"lazy"},null,8,be)]))),128))])):S("",!0),o("div",ye,[(c(!0),m(L,null,j(i.options,n=>(c(),m("div",{key:n.id,class:Y(["relative flex items-start p-3 rounded-lg border transition-all group",[Q(i.id,n.id),k(i.id)?"opacity-70 cursor-not-allowed bg-gray-50 dark:bg-gray-800":"cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50"]]),onClick:r=>!k(i.id)&&C(i,n)},[o("div",xe,[o("input",{name:`question_${i.id}`,type:"radio",checked:y(i.id,n.id),disabled:k(i.id),class:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600 disabled:text-gray-400"},null,8,_e)]),o("div",ke,[o("span",{class:"font-medium text-gray-900 dark:text-gray-100",innerHTML:n.text},null,8,Qe),n.images&&n.images.length>0?(c(),m("div",Ae,[(c(!0),m(L,null,j(n.images,r=>(c(),m("div",{key:r.id,class:"rounded overflow-hidden border border-gray-200 dark:border-gray-700"},[o("img",{src:r.full_url,class:"w-full h-24 object-cover",loading:"lazy"},null,8,$e)]))),128))])):S("",!0)])],10,ve))),128)),x(q,{name:"fade",mode:"out-in"},{default:U(()=>[o("div",Ee,[w(i.id)&&!g(i.id)?(c(),m("button",{key:0,onClick:n=>V(i.id),class:"flex items-center gap-2 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition-colors"},[x(l(_),{icon:"heroicons:pencil-square"}),a[0]||(a[0]=O(" แก้ไขคำตอบ ",-1))],8,ze)):F(i.id)||g(i.id)?(c(),m("button",{key:1,onClick:G(n=>B(i),["stop"]),disabled:l(d).isQuestionSubmitting(e.quizId,i.id),class:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"},[l(d).isQuestionSubmitting(e.quizId,i.id)?(c(),D(l(_),{key:0,icon:"eos-icons:loading",class:"animate-spin"})):(c(),D(l(_),{key:1,icon:"heroicons:check-circle"})),O(" "+z(l(d).isQuestionSubmitting(e.quizId,i.id)?"กำลังบันทึก...":"ยืนยันคำตอบ"),1)],8,Ce)):S("",!0),g(i.id)?(c(),m("button",{key:2,onClick:n=>M(i.id),class:"flex items-center gap-2 px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium transition-colors"}," ยกเลิก ",8,Te)):S("",!0)])]),_:2},1024)])])])]))),128))]))}},Be={class:"container mx-auto px-4 py-6 max-w-4xl"},Le={key:1,class:"relative"},je={class:"sticky top-4 z-20 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-blue-100 dark:border-gray-700 p-4 mb-6 flex items-center justify-between transition-all duration-300"},Oe={class:"flex items-center gap-4"},Re={class:"text-lg font-bold text-gray-800 dark:text-white truncate max-w-[200px] sm:max-w-md hidden sm:block"},Fe={class:"flex items-center gap-4"},Ve={class:"flex items-center gap-2 px-4 py-2 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-lg font-mono font-bold text-lg"},Me=["disabled"],Pe={key:0},De={class:"mt-8 flex justify-center pb-10"},Ne={key:1,class:"flex flex-col items-center justify-center p-20 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700"},We=J({__name:"attempt",setup(e){const t=K(),u=t.params.id,h=t.params.quizId,d=H(),$=X(),w=p(null),g=p(null),k=p(!0),b=p(!1),R=p([]),y=p(0),Q=p(null),C=p(null),F=ie(()=>{const n=Math.floor(y.value/60),r=y.value%60;return`${n.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}),V=async()=>{try{const n=await d.get(`/api/courses/${u}/quizzes/${h}`);if(w.value=n.quiz,R.value=w.value.questions||[],w.value.current_result)g.value=w.value.current_result;else{const r=await d.post(`/api/courses/${u}/quizzes/${h}/results`,{});g.value=r.quizResult}g.value&&g.value.duration?y.value=parseInt(g.value.duration):y.value=0,M()}catch(n){console.error(n),A.fire("Error","Failed to load quiz: "+(n.message||n),"error")}finally{k.value=!1}},M=()=>{Q.value&&clearInterval(Q.value),Q.value=N(()=>{y.value++},1e3)},B=p(!1),T=()=>{B.value=window.scrollY>300},s=()=>{window.scrollTo({top:0,behavior:"smooth"})},a=async()=>{if(!(!g.value||!g.value.id||b.value))try{await d.put(`/api/courses/${u}/quizzes/${h}/results/${g.value.id}`,{duration:y.value})}catch(n){console.error("Heartbeat failed",n)}},i=n=>{b.value||(n.preventDefault(),n.returnValue="")};I(()=>{V(),window.addEventListener("scroll",T),window.addEventListener("beforeunload",i),C.value=N(a,1e4)}),Z(()=>{Q.value&&clearInterval(Q.value),C.value&&clearInterval(C.value),window.removeEventListener("scroll",T),window.removeEventListener("beforeunload",i)}),ee((n,r,f)=>{if(b.value){f();return}A.fire({title:"ออกจากหน้าสอบ?",text:"การทำข้อสอบจะยังไม่ถูกส่ง คุณต้องการออกจริงหรือไม่?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"ใช่, ออกเลย",cancelButtonText:"ทำต่อ"}).then(P=>{P.isConfirmed?f():f(!1)})});const v=async()=>{b.value=!0;try{if(!g.value||!g.value.id)throw new Error("Result ID not found");await d.put(`/api/courses/${u}/quizzes/${h}/results/${g.value.id}`,{completed_at:new Date().toISOString(),duration:y.value}),await A.fire({icon:"success",title:"สิ้นสุดการทำข้อสอบ",text:"ระบบบันทึกเวลาเรียบร้อยแล้ว",timer:1500,showConfirmButton:!1}),$.replace(`/courses/${u}/quizzes/${h}`)}catch(n){console.error(n),A.fire("Error","เกิดข้อผิดพลาดในการบันทึกเวลา","error"),b.value=!1}};return(n,r)=>(c(),m("div",Be,[l(k)?(c(),D(oe,{key:0})):l(w)?(c(),m("div",Le,[o("div",je,[o("div",Oe,[o("h1",Re,z(l(w).title),1),r[1]||(r[1]=o("span",{class:"sm:hidden font-bold text-gray-800 dark:text-white"},"เวลาที่ใช้",-1))]),o("div",Fe,[o("div",Ve,[x(l(_),{icon:"fluent:timer-24-filled",class:"w-6 h-6"}),O(" "+z(l(F)),1)]),o("button",{onClick:v,disabled:l(b),class:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium shadow-md transition-colors flex items-center gap-2"},[r[2]||(r[2]=o("span",{class:"hidden sm:inline"},"สิ้นสุดการสอบ (หยุดเวลา)",-1)),x(l(_),{icon:"fluent:stop-24-filled",class:"w-5 h-5 sm:hidden"})],8,Me)])]),l(w).questions&&l(w).questions.length>0?(c(),m("div",Pe,[x(Se,{modelValue:l(g),"onUpdate:modelValue":r[0]||(r[0]=f=>te(g)?g.value=f:null),questions:l(w).questions,quizId:parseInt(l(h)),courseId:parseInt(l(u)),quiz:l(w),quizResult:l(g),questionApiRoute:`/api/quizs/${l(h)}`},null,8,["modelValue","questions","quizId","courseId","quiz","quizResult","questionApiRoute"]),o("div",De,[o("button",{onClick:v,class:"px-8 py-3 bg-red-600 text-white rounded-full font-bold shadow-lg hover:bg-red-700 transition flex items-center gap-2"},[x(l(_),{icon:"fluent:stop-24-filled",class:"w-5 h-5"}),r[3]||(r[3]=O(" สิ้นสุดการทำข้อสอบ (หยุดเวลา) ",-1))])])])):(c(),m("div",Ne,[x(l(_),{icon:"fluent:document-error-24-regular",class:"w-16 h-16 text-gray-300 mb-4"}),r[4]||(r[4]=o("h3",{class:"text-xl font-medium text-gray-600 dark:text-gray-400"},"ยังไม่มีคำถามในแบบทดสอบนี้",-1)),r[5]||(r[5]=o("p",{class:"text-gray-400 mt-2"},"โปรดติดต่อผู้สอน",-1))]))])):S("",!0),x(q,{"enter-active-class":"transition ease-out duration-300","enter-from-class":"opacity-0 translate-y-10","enter-to-class":"opacity-100 translate-y-0","leave-active-class":"transition ease-in duration-300","leave-from-class":"opacity-100 translate-y-0","leave-to-class":"opacity-0 translate-y-10"},{default:U(()=>[se(o("button",{onClick:s,class:"fixed bottom-6 right-6 p-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-all z-50",title:"Back to Top"},[x(l(_),{icon:"fluent:arrow-up-24-filled",class:"w-6 h-6"})],512),[[re,l(B)]])]),_:1})]))}});export{We as default};
