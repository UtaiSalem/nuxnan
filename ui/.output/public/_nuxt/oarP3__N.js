import{_ as H}from"./B2kPl_O1.js";import{q as R,a9 as V,a3 as F,c as f,a as n,b as g,u as s,t as N,d as J,F as Q,k as W,e as X,r as x,o as l,I as _,g as O,K as Y,l as Z,aE as ee,ay as te,y as se,w as L,U as I,n as oe}from"./Brb_7992.js";import{_ as re}from"./DT0SCyrs.js";import{u as P}from"./CaSR6SuD.js";import{_ as ne}from"./C_bEWirS.js";import{a as ae}from"./BB7BZ0Dd.js";import{u as ie}from"./D-aAgd9X.js";import{u as ue}from"./CJp6I_A2.js";import"./zWxPcX7x.js";import"./BQxta0Da.js";const le={class:"space-y-4"},de={class:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4"},ce={class:"flex items-center justify-between"},me={class:"flex items-center gap-3"},pe={class:"w-10 h-10 rounded-lg bg-gradient-to-br from-teal-500 to-cyan-500 flex items-center justify-center"},fe={class:"text-sm text-gray-500 dark:text-gray-400"},ge={key:0,class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},ve={key:1,class:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-12 text-center"},xe=R({__name:"GroupsList",props:{groups:{default:()=>[]},isCourseAdmin:{type:Boolean,default:!1},courseId:{},joiningGroupId:{default:null}},emits:["create","edit","join","refresh","deleted"],setup(v,{expose:a,emit:j}){const c=v,r=j,C=V(),h=P(),$=x(!1),i=x([]);F(()=>c.groups,t=>{i.value=[...t]},{immediate:!0,deep:!0});const G=t=>{Y(`/courses/${c.courseId}/groups/${t.id}`)},m=async t=>{if(await h.confirm("สมาชิกในกลุ่มจะถูกย้ายไปยังกลุ่มหลัก คุณต้องการลบกลุ่มนี้หรือไม่?","ยืนยันการลบกลุ่ม",{confirmText:"ลบกลุ่ม",cancelText:"ยกเลิก",icon:"warning",isDanger:!0})){$.value=!0;try{(await C.delete(`/api/courses/${c.courseId}/groups/${t}`)).success&&(i.value=i.value.filter(u=>u.id!==t),h.success("กลุ่มถูกลบเรียบร้อยแล้ว","ลบกลุ่มสำเร็จ"),r("deleted",t),r("refresh"))}catch(d){h.error(d.data?.msg||"เกิดข้อผิดพลาดในการลบกลุ่ม","ไม่สามารถลบกลุ่มได้")}finally{$.value=!1}}};return a({addGroup:t=>{i.value.push(t)},updateGroup:t=>{const e=i.value.findIndex(d=>d.id===t.id);e!==-1&&(i.value[e]={...i.value[e],...t})},localGroups:i}),(t,e)=>{const d=re;return l(),f("div",le,[n("div",de,[n("div",ce,[n("div",me,[n("div",pe,[g(s(_),{icon:"heroicons-outline:user-group",class:"w-5 h-5 text-white"})]),n("div",null,[e[2]||(e[2]=n("h2",{class:"text-lg font-bold text-gray-900 dark:text-white"},"กลุ่มเรียน",-1)),n("p",fe,N(s(i).length)+" กลุ่ม",1)])]),v.isCourseAdmin?(l(),f("button",{key:0,onClick:e[0]||(e[0]=u=>r("create")),class:"flex items-center gap-2 px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors"},[g(s(_),{icon:"fluent:add-24-regular",class:"w-4 h-4"}),e[3]||(e[3]=n("span",{class:"hidden sm:inline"},"เพิ่มกลุ่ม",-1))])):J("",!0)])]),s(i).length>0?(l(),f("div",ge,[(l(!0),f(Q,null,W(s(i),u=>(l(),O(d,{key:u.id,group:u,"course-id":v.courseId,"is-course-admin":v.isCourseAdmin,loading:u.id===v.joiningGroupId,onClick:G,onEdit:M=>r("edit",u),onJoin:M=>r("join",u.id),onDelete:m},null,8,["group","course-id","is-course-admin","loading","onEdit","onJoin"]))),128))])):(l(),f("div",ve,[g(s(_),{icon:"heroicons-outline:user-group",class:"w-16 h-16 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e[5]||(e[5]=n("h3",{class:"text-lg font-semibold text-gray-900 dark:text-white mb-2"},"ยังไม่มีกลุ่มเรียน",-1)),e[6]||(e[6]=n("p",{class:"text-gray-500 dark:text-gray-400 mb-4"},"รายวิชานี้ยังไม่มีกลุ่มเรียน",-1)),v.isCourseAdmin?(l(),f("button",{key:0,onClick:e[1]||(e[1]=u=>r("create")),class:"inline-flex items-center gap-2 px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors"},[g(s(_),{icon:"fluent:add-24-regular",class:"w-4 h-4"}),e[4]||(e[4]=X(" สร้างกลุ่มแรก ",-1))])):J("",!0)]))])}}}),he={key:0,class:"flex items-center justify-center py-12"},ye={class:"flex items-center gap-3"},we={class:"flex items-center justify-center w-12 h-12 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-xl"},be={class:"text-xl font-bold text-gray-900 dark:text-white"},De=R({__name:"index",setup(v){const a=I("course"),j=I("isCourseAdmin"),c=I("refreshCourse"),r=ue(),C=ie(),h=Z(),$=ee();te(),ae();const i=oe(()=>r.groups),G=x(!1),m=x(!1),y=x(null),E=V(),t=P(),e=x(null),d=async()=>{if(a?.value?.id){G.value=!0;try{await r.fetchGroups(a.value.id)}catch(o){console.error("Failed to load groups:",o)}finally{G.value=!1}}},u=()=>{y.value=null,m.value=!0},M=o=>{y.value=o,m.value=!0},B=x(null),q=async o=>{const p=h.user?.pp||0,D=$.course?.tuition_fees||0;if(p<D){await t.fire({icon:"warning",title:"ขออภัย",text:"คุณมีแต้มสะสมไม่เพียงพอที่จะสมัครเข้าร่วมกลุ่มรายวิชานี้ กรุณาเติมแต้มสะสมก่อน",confirmButtonText:"ตกลง"});return}const w=C.member?.group_id,U=h.user?.id;B.value=o;try{const k=await E.post(`/api/courses/${a.value.id}/groups/${o}/members`);let b=k.courseMemberOfAuth;if(b&&b.data&&(b=b.data),w&&w!=o){const S=r.getGroupById(w);S&&r.updateGroup(w,{members_count:Math.max(0,(S.members_count||0)-1),groupMemberOfAuth:null})}const A=r.getGroupById(o);if(A){const S=A.groupMemberOfAuth?A.members_count||0:(A.members_count||0)+1;r.updateGroup(o,{members_count:S,groupMemberOfAuth:{user_id:U,group_id:o,status:1,...b}})}C.setMember(b),await r.fetchGroups(a.value.id,!0),await t.success(k.message||"ดำเนินการเรียบร้อยแล้ว","สำเร็จ (Success)")}catch(k){console.error("Join Error:",k),t.error(k.data?.message||"ไม่สามารถเข้าร่วมกลุ่มได้","เกิดข้อผิดพลาด")}finally{B.value=null}},T=async()=>{a?.value?.id&&await r.fetchGroups(a.value.id,!0)},z=async o=>{c&&await c()},K=async o=>{m.value=!1,y.value?(e.value?.updateGroup(o),t.success("อัปเดตกลุ่มสำเร็จ","แก้ไขกลุ่มสำเร็จ")):(e.value?.addGroup(o),t.success("สร้างกลุ่มใหม่สำเร็จ","สร้างกลุ่มสำเร็จ"),c&&await c()),await T()};return se(async()=>{a?.value?.id&&(r.isCacheValid(a.value.id)||await d())}),F(()=>a?.value?.id,async o=>{o&&await d()}),(o,p)=>{const D=H;return l(),f("div",null,[s(G)?(l(),f("div",he,[g(s(_),{icon:"svg-spinners:ring-resize",class:"w-8 h-8 text-blue-500"})])):(l(),O(xe,{key:1,ref_key:"groupsListRef",ref:e,groups:s(i),"course-id":s(a)?.id,"is-course-admin":s(j),"joining-group-id":s(B),onCreate:u,onEdit:M,onJoin:q,onRefresh:T,onDeleted:z},null,8,["groups","course-id","is-course-admin","joining-group-id"])),g(D,{show:s(m),onClose:p[1]||(p[1]=w=>m.value=!1),"max-width":"2xl"},{title:L(()=>[n("div",ye,[n("div",we,[g(s(_),{icon:"heroicons:user-group-solid",class:"w-6 h-6 text-white"})]),n("div",null,[n("h3",be,N(s(y)?"แก้ไขกลุ่ม":"สร้างกลุ่มใหม่"),1),p[2]||(p[2]=n("p",{class:"text-sm text-gray-500 dark:text-gray-400"},"จัดการกลุ่มเรียนในรายวิชา",-1))])])]),content:L(()=>[g(ne,{"course-id":s(a)?.id,group:s(y),onSaved:K,onCancel:p[0]||(p[0]=w=>m.value=!1)},null,8,["course-id","group"])]),_:1},8,["show"])])}}});export{De as default};
