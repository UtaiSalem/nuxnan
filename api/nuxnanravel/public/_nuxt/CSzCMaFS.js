import{r as p,N as P,c as u,a as t,d as D,e as g,u as l,t as d,q as M,l as b,y as E,p as T,x as A,F as R,n as $,ay as B,o as m}from"./DuB962GZ.js";function O(k,U){const x=p(!1),w=p(!1),_=p(null),v=p(!1),c=p(1),f=p(25),i=p({startDate:"",endDate:"",status:"",zoneId:"",studentName:""}),n=P(()=>{let o=[...k.value];if(i.value.startDate&&(o=o.filter(a=>new Date(a.visit_date)>=new Date(i.value.startDate))),i.value.endDate&&(o=o.filter(a=>new Date(a.visit_date)<=new Date(i.value.endDate))),i.value.status&&(o=o.filter(a=>a.visit_status===i.value.status)),i.value.zoneId&&(o=o.filter(a=>a.zone_id==i.value.zoneId)),i.value.studentName){const a=i.value.studentName.toLowerCase();o=o.filter(r=>{const e=r.student;return e?`${e.first_name_th||e.first_name||""} ${e.last_name_th||e.last_name||""}`.toLowerCase().includes(a):!1})}return o.sort((a,r)=>new Date(r.visit_date)-new Date(a.visit_date))}),y=P(()=>Math.ceil(n.value.length/f.value)),h=P(()=>{const o=(c.value-1)*f.value,a=o+f.value;return n.value.slice(o,a)});return{showFilters:x,showDetailModal:w,selectedVisit:_,isExporting:v,currentPage:c,perPage:f,filters:i,filteredVisits:n,totalPages:y,paginatedVisits:h,toggleFilters:()=>{x.value=!x.value},clearFilters:()=>{i.value={startDate:"",endDate:"",status:"",zoneId:"",studentName:""},c.value=1},previousPage:()=>{c.value>1&&c.value--},nextPage:()=>{c.value<y.value&&c.value++},viewVisitDetails:o=>{_.value=o,w.value=!0},closeDetailModal:()=>{w.value=!1,_.value=null},exportToExcel:async()=>{v.value=!0;try{if(!n.value||n.value.length===0){alert("ไม่มีข้อมูลที่จะส่งออก กรุณาเลือกข้อมูลก่อน");return}const o=await axios.post("/api/home-visit/admin/visits/export/excel",{filters:i.value,visits:n.value.map(s=>s.id)},{responseType:"blob"});if(!o.data||o.data.size===0)throw new Error("ไม่สามารถสร้างไฟล์ Excel ได้");const a=new Blob([o.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),r=window.URL.createObjectURL(a),e=document.createElement("a");e.href=r,e.setAttribute("download",`home-visits-${new Date().toISOString().split("T")[0]}.xlsx`),document.body.appendChild(e),e.click(),document.body.removeChild(e),window.URL.revokeObjectURL(r),alert(`ส่งออกข้อมูลเรียบร้อยแล้ว (${n.value.length} รายการ)`)}catch(o){if(console.error("Export failed:",o),o.response&&o.response.data instanceof Blob){const a=new FileReader;a.onload=()=>{try{const r=JSON.parse(a.result);alert("เกิดข้อผิดพลาด: "+(r.message||"ไม่สามารถส่งออกข้อมูลได้"))}catch{alert("เกิดข้อผิดพลาดในการส่งออก กรุณาลองใหม่อีกครั้ง")}},a.readAsText(o.response.data)}else alert("เกิดข้อผิดพลาดในการส่งออก: "+(o.message||"กรุณาลองใหม่อีกครั้ง"))}finally{v.value=!1}},getStudentFullName:o=>o?`${o.first_name_th||o.first_name||""} ${o.last_name_th||o.last_name||""}`.trim()||"ไม่ระบุชื่อ":"ไม่ระบุ",getStudentInitial:o=>o&&(o.first_name_th||o.first_name||"").charAt(0).toUpperCase()||"N"}}const q={class:"bg-white shadow overflow-hidden sm:rounded-lg"},H={class:"px-4 py-5 sm:px-6 border-b border-gray-200"},J={class:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"},G={class:"flex gap-2"},K=["disabled"],Q={key:0,class:"px-4 py-4 bg-gray-50 border-b border-gray-200"},W={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"},X=["value"],Y={class:"flex items-end"},Z={class:"px-4 py-3 bg-white border-b border-gray-200"},ee={class:"flex items-center justify-between text-sm"},te={class:"text-gray-700"},se={class:"flex items-center gap-4"},le={class:"text-gray-500"},oe={key:1,class:"p-12 text-center"},ae={key:2,class:"divide-y divide-gray-200"},ne=["onClick"],ie={class:"flex items-center justify-between"},re={class:"flex items-center flex-1"},de={class:"flex-shrink-0"},ue={class:"w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center"},me={class:"text-white font-medium text-sm"},ge={class:"ml-4 flex-1"},ce={class:"flex items-center gap-2"},fe={class:"text-sm font-medium text-gray-900"},pe={key:0,class:"text-xs text-gray-500"},xe={class:"text-sm text-gray-500 mt-1"},ve={key:0,class:"ml-2"},ye={key:1,class:"ml-2"},be={class:"flex items-center gap-3"},we={key:0,class:"text-xs text-gray-500"},_e={key:3,class:"px-4 py-3 border-t border-gray-200 bg-gray-50"},he={class:"flex items-center justify-center space-x-2"},De=["disabled"],ke={class:"text-sm text-gray-700"},Ne=["disabled"],Ce={__name:"VisitsListSection",props:{visits:{type:Array,required:!0},zones:{type:Array,required:!0}},emits:["view-details"],setup(k,{emit:U}){const x=k,w=U,_=p(x.visits);p(x.zones);const{showFilters:v,isExporting:c,currentPage:f,perPage:i,filters:n,filteredVisits:y,totalPages:h,paginatedVisits:N,toggleFilters:V,clearFilters:z,previousPage:C,nextPage:F,exportToExcel:S,getStudentFullName:I,getStudentInitial:L}=O(_),j=r=>({pending:"รอดำเนินการ","in-progress":"กำลังดำเนินการ",completed:"เสร็จสิ้น",cancelled:"ยกเลิก"})[r]||r,o=r=>r?new Date(r).toLocaleDateString("th-TH",{year:"numeric",month:"short",day:"numeric"}):"-",a=r=>{w("view-details",r)};return(r,e)=>(m(),u("div",q,[t("div",H,[t("div",J,[e[13]||(e[13]=t("div",null,[t("h3",{class:"text-lg leading-6 font-medium text-gray-900"},[t("i",{class:"fas fa-clipboard-list mr-2 text-indigo-600"}),g(" การเยี่ยมบ้านทั้งหมด ")]),t("p",{class:"mt-1 text-sm text-gray-500"}," ค้นหาและดูรายละเอียดการเยี่ยมบ้าน ")],-1)),t("div",G,[t("button",{onClick:e[0]||(e[0]=(...s)=>l(S)&&l(S)(...s)),class:"inline-flex items-center px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors",disabled:l(c)},[e[11]||(e[11]=t("i",{class:"fas fa-file-excel mr-2"},null,-1)),g(" "+d(l(c)?"กำลังส่งออก...":"Excel"),1)],8,K),t("button",{onClick:e[1]||(e[1]=(...s)=>l(V)&&l(V)(...s)),class:M([l(v)?"bg-indigo-600 text-white":"bg-gray-100 text-gray-700","inline-flex items-center px-3 py-2 hover:bg-indigo-700 text-sm font-medium rounded-lg transition-colors"])},[...e[12]||(e[12]=[t("i",{class:"fas fa-filter mr-2"},null,-1),g(" ตัวกรอง ",-1)])],2)])])]),l(v)?(m(),u("div",Q,[t("div",W,[t("div",null,[e[14]||(e[14]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"วันที่เริ่มต้น",-1)),b(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>l(n).startDate=s),type:"date",class:"w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"},null,512),[[E,l(n).startDate]])]),t("div",null,[e[15]||(e[15]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"วันที่สิ้นสุด",-1)),b(t("input",{"onUpdate:modelValue":e[3]||(e[3]=s=>l(n).endDate=s),type:"date",class:"w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"},null,512),[[E,l(n).endDate]])]),t("div",null,[e[17]||(e[17]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"สถานะ",-1)),b(t("select",{"onUpdate:modelValue":e[4]||(e[4]=s=>l(n).status=s),class:"w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"},[...e[16]||(e[16]=[A('<option value="">ทั้งหมด</option><option value="pending">รอดำเนินการ</option><option value="in-progress">กำลังดำเนินการ</option><option value="completed">เสร็จสิ้น</option><option value="cancelled">ยกเลิก</option>',5)])],512),[[T,l(n).status]])]),t("div",null,[e[19]||(e[19]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"โซน",-1)),b(t("select",{"onUpdate:modelValue":e[5]||(e[5]=s=>l(n).zoneId=s),class:"w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"},[e[18]||(e[18]=t("option",{value:""},"ทั้งหมด",-1)),(m(!0),u(R,null,$(k.zones,s=>(m(),u("option",{key:s.id,value:s.id},d(s.zone_name),9,X))),128))],512),[[T,l(n).zoneId]])]),t("div",null,[e[20]||(e[20]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"ค้นหานักเรียน",-1)),b(t("input",{"onUpdate:modelValue":e[6]||(e[6]=s=>l(n).studentName=s),type:"text",placeholder:"ชื่อนักเรียน...",class:"w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"},null,512),[[E,l(n).studentName]])]),t("div",Y,[t("button",{onClick:e[7]||(e[7]=(...s)=>l(z)&&l(z)(...s)),class:"w-full px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium rounded-lg transition-colors"},[...e[21]||(e[21]=[t("i",{class:"fas fa-times mr-2"},null,-1),g(" ล้างตัวกรอง ",-1)])])])])])):D("",!0),t("div",Z,[t("div",ee,[t("span",te," แสดง "+d(l(N).length)+" จาก "+d(l(y).length)+" รายการ ",1),t("div",se,[t("span",le,"หน้า "+d(l(f))+"/"+d(l(h)),1),b(t("select",{"onUpdate:modelValue":e[8]||(e[8]=s=>B(i)?i.value=s:null),class:"border-gray-300 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500"},[...e[22]||(e[22]=[t("option",{value:10},"10",-1),t("option",{value:25},"25",-1),t("option",{value:50},"50",-1)])],512),[[T,l(i)]])])])]),l(y).length===0?(m(),u("div",oe,[...e[23]||(e[23]=[t("div",{class:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"},[t("i",{class:"fas fa-inbox text-gray-400 text-2xl"})],-1),t("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"ไม่พบข้อมูล",-1),t("p",{class:"text-gray-500"},"ไม่พบรายการเยี่ยมบ้านตามเงื่อนไขที่ค้นหา",-1)])])):(m(),u("ul",ae,[(m(!0),u(R,null,$(l(N),s=>(m(),u("li",{key:s.id,class:"px-4 py-4 hover:bg-gray-50 cursor-pointer transition-colors",onClick:Ve=>a(s)},[t("div",ie,[t("div",re,[t("div",de,[t("div",ue,[t("span",me,d(l(L)(s.student)),1)])]),t("div",ge,[t("div",ce,[t("div",fe,d(l(I)(s.student)),1),s.zone?(m(),u("span",pe,[e[24]||(e[24]=t("i",{class:"fas fa-map-marker-alt mr-1"},null,-1)),g(d(s.zone.zone_name),1)])):D("",!0)]),t("div",xe,[g(d(o(s.visit_date))+" ",1),s.visitor_name?(m(),u("span",ve,[e[25]||(e[25]=g(" | ",-1)),e[26]||(e[26]=t("i",{class:"fas fa-user text-xs"},null,-1)),g(" "+d(s.visitor_name),1)])):s.participants&&s.participants.length>0?(m(),u("span",ye,[e[27]||(e[27]=g(" | ",-1)),e[28]||(e[28]=t("i",{class:"fas fa-users text-xs"},null,-1)),g(" "+d(s.participants.length)+" คน ",1)])):D("",!0)])])]),t("div",be,[s.images_count?(m(),u("span",we,[e[29]||(e[29]=t("i",{class:"fas fa-images mr-1"},null,-1)),g(d(s.images_count),1)])):D("",!0),t("span",{class:M([s.visit_status==="completed"?"bg-green-100 text-green-800":s.visit_status==="in-progress"?"bg-yellow-100 text-yellow-800":s.visit_status==="pending"?"bg-orange-100 text-orange-800":"bg-gray-100 text-gray-800","inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"])},d(j(s.visit_status)),3),e[30]||(e[30]=t("i",{class:"fas fa-chevron-right text-gray-400 text-sm"},null,-1))])])],8,ne))),128))])),l(y).length>0?(m(),u("div",_e,[t("div",he,[t("button",{onClick:e[9]||(e[9]=(...s)=>l(C)&&l(C)(...s)),disabled:l(f)===1,class:"px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"},[...e[31]||(e[31]=[t("i",{class:"fas fa-chevron-left"},null,-1)])],8,De),t("span",ke," หน้า "+d(l(f))+" จาก "+d(l(h)),1),t("button",{onClick:e[10]||(e[10]=(...s)=>l(F)&&l(F)(...s)),disabled:l(f)===l(h),class:"px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"},[...e[32]||(e[32]=[t("i",{class:"fas fa-chevron-right"},null,-1)])],8,Ne)])])):D("",!0)]))}};export{Ce as default};
