import{_ as K}from"./CehGOp-7.js";import{z as N,af as O,r as g,a4 as R,c as p,a,d as J,b as v,u as s,t as V,F as Q,n as U,e as W,o as l,I as _,j as F,O as X,ah as Z,az as ee,an as te,N as se,f as oe,Y as I,w as L}from"./DuB962GZ.js";import{_ as re}from"./BPmN9HRH.js";import{u as z}from"./CaSR6SuD.js";import{_ as ae}from"./BddAafDO.js";import{a as ne}from"./Czq9JhUr.js";import{u as ie}from"./C_KBwUJh.js";import{u as ue}from"./BldT-Pqa.js";import"./CouwXKwP.js";import"./BQxta0Da.js";const le={class:"space-y-4"},de={class:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4"},ce={class:"flex items-center justify-between"},me={class:"flex items-center gap-3"},fe={class:"w-10 h-10 rounded-lg bg-gradient-to-br from-teal-500 to-cyan-500 flex items-center justify-center"},pe={class:"text-sm text-gray-500 dark:text-gray-400"},ge={key:0,class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},ve={key:1,class:"bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-12 text-center"},he=N({__name:"GroupsList",props:{groups:{default:()=>[]},isCourseAdmin:{type:Boolean,default:!1},courseId:{},joiningGroupId:{default:null}},emits:["create","edit","join","refresh","deleted"],setup(h,{expose:n,emit:S}){const c=h,r=S,C=O(),x=z(),$=g(!1);g(!1);const i=g([]);R(()=>c.groups,t=>{i.value=[...t]},{immediate:!0,deep:!0});const G=t=>{X(`/courses/${c.courseId}/groups/${t.id}`)},m=async t=>{if(await x.confirm("สมาชิกในกลุ่มจะถูกย้ายไปยังกลุ่มหลัก คุณต้องการลบกลุ่มนี้หรือไม่?","ยืนยันการลบกลุ่ม",{confirmText:"ลบกลุ่ม",cancelText:"ยกเลิก",icon:"warning",isDanger:!0})){$.value=!0;try{(await C.delete(`/api/courses/${c.courseId}/groups/${t}`)).success&&(i.value=i.value.filter(u=>u.id!==t),x.success("กลุ่มถูกลบเรียบร้อยแล้ว","ลบกลุ่มสำเร็จ"),r("deleted",t),r("refresh"))}catch(d){x.error(d.data?.msg||"เกิดข้อผิดพลาดในการลบกลุ่ม","ไม่สามารถลบกลุ่มได้")}finally{$.value=!1}}};return n({addGroup:t=>{i.value.push(t)},updateGroup:t=>{const e=i.value.findIndex(d=>d.id===t.id);e!==-1&&(i.value[e]={...i.value[e],...t})},localGroups:i}),(t,e)=>{const d=re;return l(),p("div",le,[a("div",de,[a("div",ce,[a("div",me,[a("div",fe,[v(s(_),{icon:"heroicons-outline:user-group",class:"w-5 h-5 text-white"})]),a("div",null,[e[2]||(e[2]=a("h2",{class:"text-lg font-bold text-gray-900 dark:text-white"},"กลุ่มเรียน",-1)),a("p",pe,V(s(i).length)+" กลุ่ม",1)])]),h.isCourseAdmin?(l(),p("button",{key:0,onClick:e[0]||(e[0]=u=>r("create")),class:"flex items-center gap-2 px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors"},[v(s(_),{icon:"fluent:add-24-regular",class:"w-4 h-4"}),e[3]||(e[3]=a("span",{class:"hidden sm:inline"},"เพิ่มกลุ่ม",-1))])):J("",!0)])]),s(i).length>0?(l(),p("div",ge,[(l(!0),p(Q,null,U(s(i),u=>(l(),F(d,{key:u.id,group:u,"course-id":h.courseId,"is-course-admin":h.isCourseAdmin,loading:u.id===h.joiningGroupId,onClick:G,onEdit:M=>r("edit",u),onJoin:M=>r("join",u.id),onDelete:m},null,8,["group","course-id","is-course-admin","loading","onEdit","onJoin"]))),128))])):(l(),p("div",ve,[v(s(_),{icon:"heroicons-outline:user-group",class:"w-16 h-16 text-gray-300 dark:text-gray-600 mx-auto mb-4"}),e[5]||(e[5]=a("h3",{class:"text-lg font-semibold text-gray-900 dark:text-white mb-2"},"ยังไม่มีกลุ่มเรียน",-1)),e[6]||(e[6]=a("p",{class:"text-gray-500 dark:text-gray-400 mb-4"},"รายวิชานี้ยังไม่มีกลุ่มเรียน",-1)),h.isCourseAdmin?(l(),p("button",{key:0,onClick:e[1]||(e[1]=u=>r("create")),class:"inline-flex items-center gap-2 px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors"},[v(s(_),{icon:"fluent:add-24-regular",class:"w-4 h-4"}),e[4]||(e[4]=W(" สร้างกลุ่มแรก ",-1))])):J("",!0)]))])}}}),xe={key:0,class:"flex items-center justify-center py-12"},ye={class:"flex items-center gap-3"},we={class:"flex items-center justify-center w-12 h-12 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-xl"},be={class:"text-xl font-bold text-gray-900 dark:text-white"},De=N({__name:"index",setup(h){const n=I("course"),S=I("isCourseAdmin"),c=I("refreshCourse"),r=ue(),C=ie(),x=Z(),$=ee();te(),ne();const i=se(()=>r.groups),G=g(!1),m=g(!1),y=g(null),E=O(),t=z(),e=g(null),d=async()=>{if(n?.value?.id){G.value=!0;try{await r.fetchGroups(n.value.id)}catch(o){console.error("Failed to load groups:",o)}finally{G.value=!1}}},u=()=>{y.value=null,m.value=!0},M=o=>{y.value=o,m.value=!0},B=g(null),P=async o=>{const f=x.user?.pp||0,D=$.course?.tuition_fees||0;if(f<D){await t.fire({icon:"warning",title:"ขออภัย",text:"คุณมีแต้มสะสมไม่เพียงพอที่จะสมัครเข้าร่วมกลุ่มรายวิชานี้ กรุณาเติมแต้มสะสมก่อน",confirmButtonText:"ตกลง"});return}const w=C.member?.group_id,H=x.user?.id;B.value=o;try{const k=await E.post(`/api/courses/${n.value.id}/groups/${o}/members`);let b=k.courseMemberOfAuth;if(b&&b.data&&(b=b.data),w&&w!=o){const A=r.getGroupById(w);A&&r.updateGroup(w,{members_count:Math.max(0,(A.members_count||0)-1),groupMemberOfAuth:null})}const j=r.getGroupById(o);if(j){const A=j.groupMemberOfAuth?j.members_count||0:(j.members_count||0)+1;r.updateGroup(o,{members_count:A,groupMemberOfAuth:{user_id:H,group_id:o,status:1,...b}})}C.setMember(b),await r.fetchGroups(n.value.id,!0),await t.success(k.message||"ดำเนินการเรียบร้อยแล้ว","สำเร็จ (Success)")}catch(k){console.error("Join Error:",k),t.error(k.data?.message||"ไม่สามารถเข้าร่วมกลุ่มได้","เกิดข้อผิดพลาด")}finally{B.value=null}},T=async()=>{n?.value?.id&&await r.fetchGroups(n.value.id,!0)},Y=async o=>{c&&await c()},q=async o=>{m.value=!1,y.value?(e.value?.updateGroup(o),t.success("อัปเดตกลุ่มสำเร็จ","แก้ไขกลุ่มสำเร็จ")):(e.value?.addGroup(o),t.success("สร้างกลุ่มใหม่สำเร็จ","สร้างกลุ่มสำเร็จ"),c&&await c()),await T()};return oe(async()=>{n?.value?.id&&(r.isCacheValid(n.value.id)||await d())}),R(()=>n?.value?.id,async o=>{o&&await d()}),(o,f)=>{const D=K;return l(),p("div",null,[s(G)?(l(),p("div",xe,[v(s(_),{icon:"svg-spinners:ring-resize",class:"w-8 h-8 text-blue-500"})])):(l(),F(he,{key:1,ref_key:"groupsListRef",ref:e,groups:s(i),"course-id":s(n)?.id,"is-course-admin":s(S),"joining-group-id":s(B),onCreate:u,onEdit:M,onJoin:P,onRefresh:T,onDeleted:Y},null,8,["groups","course-id","is-course-admin","joining-group-id"])),v(D,{show:s(m),onClose:f[1]||(f[1]=w=>m.value=!1),"max-width":"2xl"},{title:L(()=>[a("div",ye,[a("div",we,[v(s(_),{icon:"heroicons:user-group-solid",class:"w-6 h-6 text-white"})]),a("div",null,[a("h3",be,V(s(y)?"แก้ไขกลุ่ม":"สร้างกลุ่มใหม่"),1),f[2]||(f[2]=a("p",{class:"text-sm text-gray-500 dark:text-gray-400"},"จัดการกลุ่มเรียนในรายวิชา",-1))])])]),content:L(()=>[v(ae,{"course-id":s(n)?.id,group:s(y),onSaved:q,onCancel:f[0]||(f[0]=w=>m.value=!1)},null,8,["course-id","group"])]),_:1},8,["show"])])}}});export{De as default};
